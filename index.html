<html>

<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"> 
	<title>My first three.js app</title>
	<style>
		body {
			margin: 0;
		}

		canvas {
			width: 100%;
			height: 100%
		}

		.controls{
			padding:20px;
			font-size:20pt;
			font-weight:bold;
			background:rgba(255,255,255,0.5);
			color:#777;
			border:1px solid white;
			border-radius:40px;
			
		}

		.controls-moveright{
			position:absolute;
			bottom:10px;
			right:10px;
		}

		.controls-moveleft{
			position:absolute;
			bottom:10px;
			left:10px;
		}

		.controls-fullscreen{
			position: absolute;
			top:10px;
			right:10px;
			border-radius:0px;
			font-size:12pt;
			padding:5px;
		}

		.noSelect {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
	</style>
</head>

<body onkeydown="movement_keydown(event)" onkeyup="movement_keyup(event)" id="bodyy"> 
	<button class="controls controls-moveright noSelect" ontouchstart="fakeKeydown('ArrowRight');" ontouchend="clearInterval(touchinterval);moveright_keydown = false;">&gt;&gt;</button>
	<button class="controls controls-moveleft noSelect" ontouchstart="fakeKeydown('ArrowLeft');" ontouchend="clearInterval(touchinterval);moveleft_keydown = false;">&lt;&lt;</button>
	<button class="controls controls-fullscreen noSelect" onclick="toggleFullScreen()">Full Screen</button>
	<script src="http://www.threejs.org/build/three.js"></script>
	<script src="http://www.threejs.org/build/three.min.js"></script>
	<script src="http://www.threejs.org/examples/js/controls/OrbitControls.js"></script>
	<script src="http://www.threejs.org/examples/js/loaders/OBJLoader.js"></script>
	<script src="http://www.threejs.org/examples/js/loaders/MTLLoader.js"></script>
	<script src="http://www.threejs.org/examples/js/loaders/ColladaLoader.js"></script>
	<script src='js/threex.skymap/threex.skymap.js'></script>
	<script src='js/threex.skymap/threex.texturecube.js'></script>
	<script src='js/threex.skymap/threex.cubetexturehcross.js'></script>
	<script src="js/threex.spaceships/threex.spaceships.js"></script>

	<script>
		var scene = new THREE.Scene();
		var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.001, 1000);
		var mySpaceship;
		let moveleft_keydown = false;
		let moveright_keydown = false;
		let moveup_keydown = false;
		let movedown_keydown = false;
		let touchend = false;

		function toggleFullScreen() {
			if ((document.fullScreenElement && document.fullScreenElement !== null) ||    
			(!document.mozFullScreen && !document.webkitIsFullScreen)) {
				if (document.documentElement.requestFullScreen) {  
				document.documentElement.requestFullScreen();  
				} else if (document.documentElement.mozRequestFullScreen) {  
				document.documentElement.mozRequestFullScreen();  
				} else if (document.documentElement.webkitRequestFullScreen) {  
				document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);  
				}  
			} else {  
				if (document.cancelFullScreen) {  
				document.cancelFullScreen();  
				} else if (document.mozCancelFullScreen) {  
				document.mozCancelFullScreen();  
				} else if (document.webkitCancelFullScreen) {  
				document.webkitCancelFullScreen();  
				}  
			}  
		}

		var renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);

		// var controls = new THREE.OrbitControls( camera,renderer.domElement );
		camera.position.set( -0.1, 0.05, 0 );
		camera.rotation.y = -90*Math.PI/180;
		// controls.update();

		
		(function(){
			var object3d	= new THREE.AmbientLight(0x101010*8)
			object3d.name	= 'Ambient light'
			scene.add(object3d)

			var object3d	= new THREE.DirectionalLight('white', 0.225)
			object3d.position.set(2.6,1,3)
			object3d.name	= 'Back light'
			scene.add(object3d)

			var object3d	= new THREE.DirectionalLight('white', 0.375)
			object3d.position.set(-2, -1, 0)
			object3d.name 	= 'Key light'
			scene.add(object3d)

			var object3d	= new THREE.DirectionalLight('white', 0.5*1)
			object3d.position.set(3, 3, 2)
			object3d.name	= 'Fill light'
			scene.add(object3d)		
		})()

		var sky	= THREEx.createSkymap('skybox');
		scene.add( sky );	
		// sky.add(camera);

		var geometry = new THREE.PlaneGeometry( 10000,10000, 32 );
		var material = new THREE.MeshPhongMaterial( {color: 0xffffff, side: THREE.DoubleSide} );
		var plane = new THREE.Mesh( geometry, material );
		scene.add( plane );
		plane.rotation.x = 90*Math.PI/180;
		plane.position.y = -10;
		floorTexture = THREE.ImageUtils.loadTexture("images/cloud.png");
		floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
		floorTexture.repeat.set(100,100);
		material.map = floorTexture;
		material.transparent = true;
		material.opacity = 0.5;

		THREEx.SpaceShips.loadShuttle01(function(object3d){
			scene.add(object3d)
			object3d.position.x = 400;
			object3d.rotation.y = 90*Math.PI/180;
		})

		var loadingManager = new THREE.LoadingManager( function() {
			scene.add( mySpaceship );
			// scene.add(plane);
		} );

		// var loader  = new THREEx.UniversalLoader()
		var loader	= new THREE.ColladaLoader(loadingManager);

		var url = 'models/SS1.dae';
		loader.load(url, function(object3d){
			mySpaceship = object3d.scene;
			mySpaceship.add(sky);
		})
		
		var animate = function () {
			if(mySpaceship !== undefined){
				mySpaceship.position.x +=0.5;
				camera.position.x +=0.5;
				if(mySpaceship.position.x >= 900){
					mySpaceship.position.x = 0;
					camera.position.x = -0.1;
				}

				if(moveleft_keydown == false){
					if(mySpaceship.rotation.x <0){
						mySpaceship.rotation.x +=3*Math.PI/180;
					}
				}

				if(moveright_keydown == false){
					if(mySpaceship.rotation.x >0){
						mySpaceship.rotation.x -=3*Math.PI/180;
					}
				}

				if(moveup_keydown == false){
					if(mySpaceship.rotation.z >0){
						mySpaceship.rotation.z -=3*Math.PI/180;
					}
				}
				
				if(movedown_keydown == false){
					if(mySpaceship.rotation.z <0){
						mySpaceship.rotation.z +=3*Math.PI/180;
					}
				}

			}
			requestAnimationFrame(animate);

	
			// controls.update();
			renderer.render(scene, camera);
		};
		// renderer.render(scene, camera);
		animate();

		fakeKeydown = function(key){
			touchinterval = setInterval(()=>{
				var e = new Event("keydown");
				e.key=key;    // just enter the char you want to send 
				e.keyCode=e.key.charCodeAt(0);
				e.which=e.keyCode;
				e.altKey=false;
				e.ctrlKey=true;
				e.shiftKey=false;
				e.metaKey=false;
				e.bubbles=true;
				document.getElementById('bodyy').dispatchEvent(e);
				if(touchend == true){
					clearInterval(touchinterval);
				}
			},30)
		
		}

		movement_keydown = function(event){
			if(event.key == "ArrowLeft"){
				moveleft_keydown = true;
			}
			if(event.key == "ArrowRight"){
				moveright_keydown = true;
			}
			if(event.key == "ArrowUp"){
				moveup_keydown = true;
			}
			if(event.key == "ArrowDown"){
				movedown_keydown = true;
			}
			updateMovement();
		}

		movement_keyup = function(event){
			if(event.key == "ArrowLeft"){
				moveleft_keydown = false;
			}
			if(event.key == "ArrowRight"){
				moveright_keydown = false;
			}
			if(event.key == "ArrowUp"){
				moveup_keydown = false;
			}
			if(event.key == "ArrowDown"){
				movedown_keydown = false;
			}
			updateMovement();
		}

		updateMovement = function(){
			if(moveleft_keydown == true){
				if(mySpaceship.rotation.x > -90*Math.PI/180){
					mySpaceship.rotation.x -= 2*Math.PI/180;
				}
				if(mySpaceship.rotation.x < 0*Math.PI/180 ){
					mySpaceship.position.z -= -1*(mySpaceship.rotation.x*180/Math.PI)/50 ;
					camera.position.z -= -1*(mySpaceship.rotation.x*180/Math.PI)/50;
				}
			}
	

			if(moveright_keydown == true){
				if(mySpaceship.rotation.x < 90*Math.PI/180 ){
					mySpaceship.rotation.x +=2*Math.PI/180;
				}
				if(mySpaceship.rotation.x > 0*Math.PI/180){
					mySpaceship.position.z += (mySpaceship.rotation.x*180/Math.PI)/50;
					camera.position.z += (mySpaceship.rotation.x*180/Math.PI)/50;
				}
			}

			
			if(moveup_keydown == true){
				if(mySpaceship.rotation.z < 90*Math.PI/180 ){
					mySpaceship.rotation.z +=2*Math.PI/180;
				}
				if(mySpaceship.rotation.z > 0*Math.PI/180){
					mySpaceship.position.y +=(mySpaceship.rotation.z*180/Math.PI)/50;
					camera.position.y +=(mySpaceship.rotation.z*180/Math.PI)/50;
				}
			}
				
			if(movedown_keydown == true){
				if(mySpaceship.rotation.z > -90*Math.PI/180 ){
					mySpaceship.rotation.z -=2*Math.PI/180;
				}
				if(mySpaceship.rotation.z < 0*Math.PI/180){
					mySpaceship.position.y -=-1*(mySpaceship.rotation.z*180/Math.PI)/50;
					camera.position.y -=-1*(mySpaceship.rotation.z*180/Math.PI)/50;
				}
			}

		}
	</script>
</body>

</html>